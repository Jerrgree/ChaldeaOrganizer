@using Blazored.Typeahead
@using ChaldeaCommon.Extensions
@using ChaldeaCommon.Data
@using BlazorStrap

@inherits NewItemModalBase<Tuple<string, int>>

<BSModal IsOpen="@IsOpen" NoBackdrop="true" Class="@ModalClass">
    <BSModalHeader OnClick="Cancel">
        New Material
    </BSModalHeader>
    <BSModalBody>
        <div class="col-sm-8 col-md-8">
            <div class="form-group">
                <label>Item</label>
                <BlazoredTypeahead SearchMethod="@SearchForMaterials"
                                   @bind-Value="@material">
                    <SelectedTemplate>
                        @context.GetMaterialLabel()
                    </SelectedTemplate>
                    <ResultTemplate>
                        <img src="/Assets/@(context).png" /> @context.GetMaterialLabel()
                    </ResultTemplate>
                </BlazoredTypeahead>
            </div>
        </div>
        <div class="col-sm-4 col-md-4">
            <div class="form-group">
                <label>Quantity</label>
                <input class="form-control" @bind="@quantity" />
            </div>
        </div>
    </BSModalBody>
    <BSModalFooter>
        <button type="button" @onclick="@Cancel" class="btn btn-danger">Cancel</button>
        <button type="button" @onclick="@OnAddItem" class="btn btn-success" disabled="@CannotAddItem">Save</button>
    </BSModalFooter>
</BSModal>

@code {
    protected override bool CannotAddItem => string.IsNullOrWhiteSpace(material) || quantity <= 0;

    private string material;

    private int quantity = 0;

    protected Task<IEnumerable<string>> SearchForMaterials(string query)
    {
        query = query.ToLower();
        return Task.FromResult(Materials.GetMaterials()
            .Where(x => x.ToLower().Contains(query) || x.GetMaterialLabel().ToLower().Contains(query)));
    }

    protected override void OnAddItem()
    {
        AddItem?.Invoke(new Tuple<string, int>(material, quantity));

        Reset();
    }

    protected override void Reset()
    {
        material = "";
        quantity = 0;
        IsOpen = false;
    }
}